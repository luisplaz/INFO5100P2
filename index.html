<html>
<head>
	<title>Project2</title>
	<script src="https://d3js.org/d3.v4.min.js"></script>
	<script src="http://d3js.org/topojson.v2.min.js"></script>

	<style>

		.arcs {
			stroke-width: 0.5px;
			stroke: tomato;
			pointer-events: none;
			fill: none;
		}

		#slider {
			fill: black;
			stroke: gray;
		}

	</style>

</head>

<body>

	<svg id="map" width="500" height="600"></svg>

	<script>

		var mapData;
		var states;
		var flightData;
		var chosenDate;
		var chosenDateFlights;
		var chosenRouteFlights;

		d3.queue()
		.defer(d3.json, "us.json")
		.defer(d3.csv, "JanuaryData.csv")
		.await(function (error, rawMap, rawFlights) {
			mapData = rawMap;
			flightData = rawFlights;
			states = topojson.feature(rawMap, rawMap.objects.states);
			showMap();
		});

		function showMap(){

			var svg = d3.select("#map");
			projection = d3.geoAlbersUsa();
			var pathGenerator = d3.geoPath().projection(projection);

			projection.fitExtent([[0,0], [svg.attr("width"), svg.attr("height")]], states);
			pathGenerator = d3.geoPath().projection(projection);

			var paths = svg.selectAll("path.state").data(states.features);
			paths.enter().append("path").attr("class", "state")
			.merge(paths)
			.style("fill", "white")
			.attr("stroke", "#ccc")
			.attr("stroke-width", 0.8)
			.attr("d", function (state) {
				return pathGenerator(state);
			});

			var arcs = svg.selectAll("path.arcs");

			arcs.data(flightData)
			.enter()
			.append("path")
			.style("opacity", "0")
			.attr("id" , function(d,i){
				return "line" + i;
			})
			.attr("class", "arcs")
			.attr('d', function(d) {
				return lngLatToArc(d, [Number(d.OLONGITUDE), Number(d.OLATITUDE)], [Number(d.DLONGITUDE), Number(d.DLATITUDE)], 5)
			});
			d3.selectAll(".arcs").style("opacity", "0.5");

			d3.selectAll(".arcs").each(function(d,i){

				var totalLength = d3.select("#line" + i).node().getTotalLength();

				d3.selectAll("#line" + i)
				.attr("stroke-dasharray", totalLength + " " + totalLength)
				.attr("stroke-dashoffset", totalLength)
				.transition()
				.duration(5000)
				//.delay(100*i)
				.attr("stroke-dashoffset", 2 * totalLength);
			});

			// show the slider
			var x1 = 50;
			var x2 = 450;
			var y = 480;
			var radius = 10;
			chosenDate = 1;
			var sliderLine = svg.append("line")
			                    .attr("x1", x1)
                          .attr("x2", x2)
                          .attr("y1", y)
                          .attr("y2", y)
                          .style("stroke", "gray")
                          .style("stroke-linecap", "round")
                          .style("stroke-width", 5);

			var circle = svg.append("circle")
										  .attr("r", radius)
											.attr("id", "slider")
										  .attr("cy", y)
								      .attr("cx", x1)
											.call(d3.drag()
											.on("start", dragstarted)
											.on("drag", dragged)
											.on("end", dragended));
			var Slidertext = svg.append("text")
			                    .attr("x", x1)
													.attr("y", y + 30)
													.text(chosenDate);


			function dragstarted() {
				d3.select(this).raise().classed("active", true);
			}

			function dragended() {
				d3.select(this).classed("active", false);
				updateDate(chosenDate);
			}

			function dragged() {
				var chosenDate = findNearstDate(d3.event.x);
				var loc = x1 + (chosenDate - 1) *(x2 - x1)/30;
				d3.select(this).attr("cx", loc);
				Slidertext.attr("x", loc).text(chosenDate);
			}

			function findNearstDate(currentX){
				var length = (x2 - x1)/30;
				var i = 0;
				if(currentX <= x1 + length/2) return 1;
				else if (currentX >= x2 - length/2) return 31;
				for(i = 0; i < 31; i++){
						if(currentX >= x1 + length/2 + length * i && currentX < x1 + length/2 + length * (i+1)) return i+2;
					}
				return i;
			}

			function plotRoutes(){

			}
		}

		function updateDate(date){
			chosenDateFlights = [];
			flightData.forEach(
				function(d, i){
					if((Number(d.DAY) == date)) chosenDateFlights.push(d);
				}
			)
		}



		function lngLatToArc(d, sourceLngLat, targetLngLat, bend){

			bend = bend || 1;

			if (targetLngLat && sourceLngLat) {
				var sourceXY = projection( sourceLngLat ),
				targetXY = projection( targetLngLat );
				console.log(d);

		      if (!targetXY) console.log(d, targetLngLat, targetXY)
		      	var sourceX = sourceXY[0],
		      sourceY = sourceXY[1];

		      var targetX = targetXY[0],
		      targetY = targetXY[1];

		      var dx = targetX - sourceX,
		      dy = targetY - sourceY,
		      dr = Math.sqrt(dx * dx + dy * dy)*bend;

		      var west_of_source = (targetX - sourceX) < 0;
		      if (west_of_source) return "M" + targetX + "," + targetY + "A" + dr + "," + dr + " 0 0,1 " + sourceX + "," + sourceY;
		      return "M" + sourceX + "," + sourceY + "A" + dr + "," + dr + " 0 0,1 " + targetX + "," + targetY;

		  } else {
		  	return "M0,0,l0,0z";
		  }
		};

	</script>

</body>

</html>
